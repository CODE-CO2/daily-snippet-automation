name: Daily Snippet Uploader

on:
  schedule:
    # 매일 KST 08:00 == UTC 23:00 (전날)
    - cron: "0 23 * * *"
  workflow_dispatch:
    inputs:
      force_full:
        description: "Ignore cache and upload all (true/false)"
        required: false
        default: "false"

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # .snippet_state.json 캐시 복구(변경분만 업로드 핵심)
      - name: Restore cache (.snippet_state.json)
        uses: actions/cache@v4
        with:
          path: .snippet_state.json
          key: snippet-state-${{ runner.os }}-${{ github.ref }}
          restore-keys: |
            snippet-state-${{ runner.os }}-

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Run uploader
        env:
          DAILY_SNIPPET_URL: ${{ secrets.DAILY_SNIPPET_URL }}
          DAILY_SNIPPET_API_KEY: ${{ secrets.DAILY_SNIPPET_API_KEY }}
          API_ID: ${{ secrets.API_ID }}
          TEAM_NAME: ${{ secrets.TEAM_NAME }}
          DEBUG: "0"
          FORCE_FULL: ${{ github.event.inputs.force_full == 'true' && '1' || '0' }}
        run: |
          node scripts/upload-snippets.js

      - name: Save cache (.snippet_state.json)
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .snippet_state.json
          key: snippet-state-${{ runner.os }}-${{ github.ref }}-${{ github.run_id }}
