name: Daily Snippet Uploader

on:
  push:
    paths:
      - 'snippets/**'
  schedule:
    - cron: '0 0 * * *'    # ë§¤ì¼ UTC 00:00 = KST 09:00
  workflow_dispatch:
    inputs:
      date:
        description: 'ì—…ë¡œë“œí•  ë‚ ì§œ (YYYY-MM-DD, ë¹„ìš°ë©´ ì˜¤ëŠ˜ ë‚ ì§œ)'
        required: false
      content:
        description: 'ì§ì ‘ ì‘ì„±í•  ìŠ¤ë‹ˆí« ë‚´ìš©'
        required: false

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Pick date & content
        id: pick
        run: |
          if [ -n "${{ github.event.inputs.date }}" ]; then
            DATE="${{ github.event.inputs.date }}"
          else
            DATE=$(date -u -d '+9 hour' +%F)  # í•œêµ­ì‹œê°„ ì˜¤ëŠ˜
          fi
          echo "date=$DATE" >> $GITHUB_OUTPUT

          if [ -n "${{ github.event.inputs.content }}" ]; then
            CONTENT="${{ github.event.inputs.content }}"
          else
            FILE="snippets/${DATE}.md"
            if [ -f "$FILE" ]; then
              CONTENT=$(sed ':a;N;$!ba;s/\r//g;s/\n/\\n/g' "$FILE")
            else
              CONTENT="(ìë™ ì—…ë¡œë“œ) ${DATE} Snippet íŒŒì¼ì´ ì—†ìŒ"
            fi
          fi
          echo "content=$CONTENT" >> $GITHUB_OUTPUT

      - name: Upload to Daily Snippet API (Debug)
        run: |
          echo "ğŸ“¡ ì—…ë¡œë“œ ìš”ì²­ ì‹œì‘..."
          curl -v -X POST "https://daily.1000.school/api/snippet" \
            -H "Authorization: Bearer ${{ secrets.DAILY_SNIPPET_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"date\":\"${{ steps.pick.outputs.date }}\",\"content\":\"${{ steps.pick.outputs.content }}\"}" \
            -o response.json -w "\nHTTP_CODE:%{http_code}\n"

          echo "ğŸ“„ ì„œë²„ ì‘ë‹µ ë³¸ë¬¸:"
          cat response.json || true
