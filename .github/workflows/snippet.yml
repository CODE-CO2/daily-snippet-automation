name: Daily Snippet Uploader

on:
  push:
    paths:
      - 'snippets/**'
  schedule:
    - cron: '0 0 * * *'    # 매일 UTC 00:00 = KST 09:00
  workflow_dispatch:
    inputs:
      date:
        description: '업로드할 날짜 (YYYY-MM-DD, 비우면 오늘 날짜)'
        required: false
      content:
        description: '직접 작성할 스니펫 내용'
        required: false

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Pick date & content
        id: pick
        run: |
          if [ -n "${{ github.event.inputs.date }}" ]; then
            DATE="${{ github.event.inputs.date }}"
          else
            DATE=$(date -u -d '+9 hour' +%F)  # 한국시간 오늘
          fi
          echo "date=$DATE" >> $GITHUB_OUTPUT

          if [ -n "${{ github.event.inputs.content }}" ]; then
            CONTENT="${{ github.event.inputs.content }}"
          else
            FILE="snippets/${DATE}.md"
            if [ -f "$FILE" ]; then
              CONTENT=$(sed ':a;N;$!ba;s/\r//g;s/\n/\\n/g' "$FILE")
            else
              CONTENT="(자동 업로드) ${DATE} Snippet 파일이 없음"
            fi
          fi
          echo "content=$CONTENT" >> $GITHUB_OUTPUT

      - name: Upload to Daily Snippet API (Debug)
        run: |
          echo "📡 업로드 요청 시작..."
          curl -v -X POST "https://daily.1000.school/api/snippet" \
            -H "Authorization: Bearer ${{ secrets.DAILY_SNIPPET_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"date\":\"${{ steps.pick.outputs.date }}\",\"content\":\"${{ steps.pick.outputs.content }}\"}" \
            -o response.json -w "\nHTTP_CODE:%{http_code}\n"

          echo "📄 서버 응답 본문:"
          cat response.json || true
